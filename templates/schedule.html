{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary me-3">
            <i class="bi bi-arrow-left me-1"></i> Назад
        </a>
        <div>
            <h1 class="h2 mb-1">Расписание рабочих мест</h1>
            <p class="lead mb-0">На {{ formatted_date }}</p>
        </div>
    </div>

    <div class="d-flex align-items-center flex-wrap gap-2">
        <div class="btn-group me-3" role="group">
            <a href="{{ url_for('schedule', date=selected_date.isoformat(), view='day', location=location_filter) }}"
               class="btn btn-outline-primary {{ 'active' if view_type == 'day' }}" style="min-width: 100px;">
                По часам
            </a>
            <a href="{{ url_for('schedule', date=selected_date.isoformat(), view='week', location=location_filter) }}"
               class="btn btn-outline-primary {{ 'active' if view_type == 'week' }}" style="min-width: 100px;">
                По дням
            </a>
        </div>

        <div class="me-3">
            <select class="form-select" id="location-filter" onchange="applyLocationFilter()" style="min-width: 150px;">
                <option value="all">Все локации</option>
                {% for location in locations %}
                    <option value="{{ location }}"
                        {% if location_filter == location %}selected{% endif %}>
                        {{ location }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <form method="GET" class="d-flex me-2">
            <input type="hidden" name="view" value="{{ view_type }}">
            <input type="hidden" name="location" value="{{ location_filter }}">
            <input type="date" class="form-control me-2" name="date"
                   value="{{ selected_date.isoformat() }}"
                   min="{{ min_date }}" max="{{ max_date }}" style="min-width: 140px;">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-search"></i>
            </button>
        </form>

        <div class="btn-group">
            <a href="{{ url_for('schedule', date=previous_date.isoformat(), view=view_type, location=location_filter) }}" class="btn btn-outline-primary">
                <i class="bi bi-chevron-left"></i>
            </a>
            <a href="{{ url_for('schedule', date=next_date.isoformat(), view=view_type, location=location_filter) }}" class="btn btn-outline-primary">
                <i class="bi bi-chevron-right"></i>
            </a>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        {% if view_type == 'day' %}
            {# Почасовое отображение #}
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th style="min-width: 200px;">Рабочее место</th>
                            {% for hour in range(working_hours[0], working_hours[1]) %}
                                {% set next_hour = hour + 1 %}
                                <th class="text-center" style="min-width: 120px;">{{ hour }}:00 - {{ next_hour }}:00</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for location in locations %}
                            {% if location_filter == 'all' or location_filter == location %}
                                {% set places_list = location_places_list[location] %}
                                {% for place in places_list %}
                                    <tr>
                                        <td class="fw-bold">{{ location }} - {{ place }}</td>
                                        {% for hour in range(working_hours[0], working_hours[1]) %}
                                            {% set next_hour = hour + 1 %}
                                            {% set hour_start = "%02d:00"|format(hour) %}
                                            {% set hour_end = "%02d:00"|format(hour + 1) %}
                                            {% set is_occupied = false %}
                                            {% set booking_user = '' %}
                                            {% set booking_info = '' %}

                                            {% set date_str = selected_date.isoformat() %}
                                            {% set place_key = location + " - " + place %}
                                            {% if schedule[date_str] and schedule[date_str][place_key] %}
                                                {% set booking = schedule[date_str][place_key] %}
                                                {% set booking_start = booking.start %}
                                                {% set booking_end = booking.end %}

                                                {# Проверяем пересечение интервалов #}
                                                {% if (booking_start <= hour_start and booking_end >= hour_end) or
                                                      (booking_start >= hour_start and booking_start < hour_end) or
                                                      (booking_end > hour_start and booking_end <= hour_end) or
                                                      (booking_start <= hour_start and booking_end >= hour_end) %}
                                                    {% set is_occupied = true %}
                                                    {% set booking_user = booking.user %}
                                                    {% set booking_info = booking.start + ' - ' + booking.end %}
                                                {% endif %}
                                            {% endif %}

                                            {% if is_occupied %}
                                                <td class="text-center position-relative bg-danger"
                                                    data-bs-toggle="tooltip"
                                                    data-bs-placement="top"
                                                    title="Забронировал: {{ booking_user }}&#10;Время: {{ booking_info }}">
                                                    <i class="bi bi-person-fill text-white"></i>
                                                    <small class="d-block text-white">{{ booking_user }}</small>
                                                </td>
                                            {% else %}
                                                <td class="text-center bg-success">
                                                    <i class="bi bi-check-circle text-white"></i>
                                                </td>
                                            {% endif %}
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        {% elif view_type == 'week' %}
            {# Недельное отображение #}
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th style="min-width: 200px;">Рабочее место</th>
                            {% for day in week_days %}
                                <th class="text-center" style="min-width: 150px;">
                                    {{ day.date.strftime('%d.%m') }}<br>
                                    <small>{{ ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'][day.date.weekday()] }}</small>
                                </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for location in locations %}
                            {% if location_filter == 'all' or location_filter == location %}
                                {% set places_list = location_places_list[location] %}
                                {% for place in places_list %}
                                    <tr>
                                        <td class="fw-bold">{{ location }} - {{ place }}</td>
                                        {% for day in week_days %}
                                            {% set day_str = day.date.isoformat() %}
                                            {% set place_key = location + " - " + place %}
                                            {% set is_occupied = day.schedule[place_key] is defined %}
                                            {% set booking_user = '' %}
                                            {% set booking_time = '' %}

                                            {% if is_occupied %}
                                                {% set booking = day.schedule[place_key] %}
                                                {% set booking_user = booking.user %}
                                                {% set booking_time = booking.start + ' - ' + booking.end %}
                                            {% endif %}

                                            {% if is_occupied %}
                                                <td class="text-center position-relative bg-danger"
                                                    data-bs-toggle="tooltip"
                                                    data-bs-placement="top"
                                                    title="Забронировал: {{ booking_user }}&#10;Время: {{ booking_time }}">
                                                    <i class="bi bi-person-fill text-white"></i>
                                                    <small class="d-block text-white">{{ booking_user }}</small>
                                                </td>
                                            {% else %}
                                                <td class="text-center bg-success">
                                                    <i class="bi bi-check-circle text-white"></i>
                                                </td>
                                            {% endif %}
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}

        <div class="mt-4">
            <h5>Легенда:</h5>
            <div class="d-flex align-items-center mb-2">
                <div class="p-2 me-2 bg-success rounded">
                    <i class="bi bi-check-circle text-white"></i>
                </div>
                <span>Свободно</span>
            </div>
            <div class="d-flex align-items-center">
                <div class="p-2 me-2 bg-danger rounded">
                    <i class="bi bi-person-fill text-white"></i>
                </div>
                <span>Занято (наведите для информации о бронировании)</span>
            </div>
        </div>
    </div>
</div>

<script>
    // Инициализация подсказок Bootstrap
    document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
    });

    // Функция для применения фильтра по локации
    function applyLocationFilter() {
        const locationFilter = document.getElementById('location-filter').value;
        const url = new URL(window.location.href);
        url.searchParams.set('location', locationFilter);
        window.location.href = url.toString();
    }
</script>

<style>
    .table td {
        position: relative;
        min-width: 120px;
        height: 60px;
        vertical-align: middle;
    }
    .table td i {
        font-size: 1.2rem;
    }
    .btn-group .btn.active {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }
    .table th {
        vertical-align: middle;
    }
</style>
{% endblock %}