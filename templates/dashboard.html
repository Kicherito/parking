{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <!-- Приветствие -->
        <div class="hero-section animate-slide-up" data-aos="fade-up">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-5 fw-bold">Добро пожаловать, {{ username }}!</h1>
                    <p class="lead">Система бронирования рабочих мест для максимальной продуктивности</p>
                    <div class="mt-4">
                        <span class="badge bg-light text-dark me-2"><i class="bi bi-lightning-fill me-1"></i>Быстро</span>
                        <span class="badge bg-light text-dark"><i class="bi bi-shield-check me-1"></i>Надежно</span>
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <div class="feature-icon mx-auto">
                        <i class="bi bi-person-workspace"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Обновленная статистика -->
        <div class="row mb-4">
            <!-- Ближайшее бронирование -->
            <div class="col-md-4 mb-3" data-aos="fade-up" data-aos-delay="100">
                <div class="stat-card">
                    {% if nearest_booking_info %}
                        <div class="d-flex align-items-center justify-content-center mb-3">
                            <i class="bi bi-calendar-event text-primary me-3" style="font-size: 2.5rem;"></i>
                            <div>
                                <div class="stat-number">{{ nearest_booking_info.date }}</div>
                                <div class="stat-label">Ближайшее бронирование</div>
                            </div>
                        </div>
                        <div class="booking-details text-center">
                            <div class="mb-2">
                                <i class="bi bi-clock me-2 text-muted"></i>
                                <span class="fw-semibold">{{ nearest_booking_info.time }}</span>
                            </div>
                            <div class="mb-2">
                                <i class="bi bi-geo-alt me-2 text-muted"></i>
                                <span class="fw-semibold">Место {{ nearest_booking_info.place }}</span>
                            </div>
                            <div>
                                <i class="bi bi-building me-2 text-muted"></i>
                                <span class="text-muted">{{ nearest_booking_info.location }}</span>
                            </div>
                        </div>
                    {% else %}
                        <div class="stat-number">Нет</div>
                        <div class="stat-label">Ближайшее бронирование</div>
                        <div class="mt-3">
                            <i class="bi bi-calendar-event text-primary" style="font-size: 2rem;"></i>
                        </div>
                    {% endif %}
                </div>
            </div>
            <!-- Активные бронирования -->
            <div class="col-md-4 mb-3" data-aos="fade-up" data-aos-delay="200">
                <div class="stat-card">
                    <div class="stat-number">{{ bookings|length }}</div>
                    <div class="stat-label">Активных бронирований</div>
                    <div class="mt-3">
                        <i class="bi bi-calendar-check text-primary" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
            <!-- Сегодняшняя дата -->
            <div class="col-md-4 mb-3" data-aos="fade-up" data-aos-delay="300">
                <div class="stat-card">
                    <div class="stat-number">{{ today }}</div>
                    <div class="stat-label">Сегодняшняя дата</div>
                    <div class="mt-3">
                        <i class="bi bi-calendar-day text-primary" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Левая колонка: Бронирование -->
            <div class="col-lg-8">
                <div class="card mb-4" data-aos="fade-up">
                    <div class="card-header d-flex align-items-center">
                        <i class="bi bi-plus-circle me-2"></i>Забронировать рабочее место
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('book') }}" id="booking-form">
                            <input type="hidden" name="dates" id="hidden-dates">
                            <input type="hidden" name="place_id" id="selected-place-id">

                            <div class="mb-4">
                                <label class="form-label fw-semibold">Выберите локацию</label>
                                <div class="d-flex align-items-center gap-2">
                                    <select class="form-select flex-grow-1" id="location-select" required>
                                        <option value="" disabled {% if not has_default_location %}selected{% endif %}>Выберите локацию</option>
                                        {% for location in locations %}
                                            <option value="{{ location }}"
                                                {% if has_default_location and location == default_location %}selected{% endif %}>
                                                {{ location }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="save-as-default"
                                           {% if has_default_location %}checked{% endif %}>
                                    <label class="form-check-label" for="save-as-default">
                                        Использовать как локацию по умолчанию
                                    </label>
                                </div>
                                {% if has_default_location %}
                                <div class="form-text">
                                    <i class="bi bi-info-circle me-1"></i> Ваша локация по умолчанию: <strong>{{ default_location }}</strong>
                                </div>
                                {% endif %}
                            </div>

                            <div class="mb-4">
                                <label class="form-label fw-semibold">Время бронирования</label>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-clock"></i></span>
                                            <input type="time" class="form-control" name="start_time" id="start-time"
                                                   value="08:00" required>
                                        </div>
                                        <div class="form-text">Начало бронирования</div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-clock"></i></span>
                                            <input type="time" class="form-control" name="end_time" id="end-time"
                                                   value="18:00" required>
                                        </div>
                                        <div class="form-text">Окончание бронирования</div>
                                    </div>
                                </div>
                                <div id="time-validation-error" class="text-danger small mt-2" style="display: none;">
                                    <i class="bi bi-exclamation-triangle me-1"></i>Время начала не может быть больше времени окончания
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="form-label fw-semibold">Выберите даты для бронирования</label>

                                <div class="mb-3">
                                    <div class="weekdays-selector d-flex flex-wrap gap-2">
                                        <button type="button" id="select-workdays" class="btn btn-outline-primary btn-day">
                                            <i class="bi bi-calendar-week me-1"></i> Рабочие дни
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-day day-selector" data-day="1">
                                            Пн
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-day day-selector" data-day="2">
                                            Вт
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-day day-selector" data-day="3">
                                            Ср
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-day day-selector" data-day="4">
                                            Чт
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-day day-selector" data-day="5">
                                            Пт
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-day day-selector" data-day="6">
                                            Сб
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-day day-selector" data-day="0">
                                            Вс
                                        </button>
                                        <button type="button" id="clear-dates" class="btn btn-outline-danger btn-day">
                                            <i class="bi bi-x-circle me-1"></i> Очистить
                                        </button>
                                    </div>
                                </div>

                                <div id="date-picker" class="mb-3"></div>

                                <div class="selected-dates-container bg-light p-3 rounded">
                                    <h6><i class="bi bi-calendar-check me-1"></i> Выбранные даты:</h6>
                                    <div id="selected-dates" class="d-flex flex-wrap mt-2">
                                        <!-- Выбранные даты будут отображаться здесь -->
                                    </div>
                                </div>
                            </div>

                            <!-- Кнопка для проверки доступности -->
                            <button type="button" class="btn btn-primary w-100 mb-3" id="check-availability-btn">
                                <i class="bi bi-search me-2"></i>Показать доступные места
                            </button>

                            <!-- Контейнер для отображения доступных места -->
                            <div id="available-places-container" class="mt-4" style="display: none;">
                                <h5><i class="bi bi-grid me-2"></i>Доступные места в локации <span id="selected-location-name"></span>:</h5>
                                <p class="text-muted" id="selected-time-range"></p>

                                <div class="d-flex flex-wrap gap-2 mt-3" id="available-places">
                                    <!-- Доступные места будут отображаться здесь -->
                                </div>

                                <div class="status-legend mt-3">
                                    <div class="status-item">
                                        <div class="status-color status-available"></div>
                                        <span>Свободно</span>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-color status-unavailable"></div>
                                        <span>Занято</span>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-success w-100 mt-3" id="book-button" disabled>
                                <i class="bi bi-check-circle me-2"></i>Забронировать выбранное место
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Правая колонка: Мои бронирования -->
            <div class="col-lg-4">
                <div class="card mb-4" data-aos="fade-up" data-aos-delay="100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-list-check me-2"></i>Мои бронирования
                        </div>
                        <div class="d-flex gap-2">
                            {% if bookings %}
                            <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteAllModal">
                                <i class="bi bi-trash"></i> Удалить все
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Фильтр по диапазону дат -->
                        <div class="mb-4">
                            <form method="GET" id="filter-form">
                                <div class="row g-2">
                                    <div class="col-12">
                                        <label class="form-label small fw-semibold">Фильтр по дате:</label>
                                    </div>
                                    <div class="col-md-6">
                                        <input type="date" class="form-control form-control-sm" name="start_date"
                                               value="{{ start_date if start_date else '' }}"
                                               min="{{ min_date }}" max="{{ max_date }}" placeholder="Начальная дата">
                                    </div>
                                    <div class="col-md-6">
                                        <input type="date" class="form-control form-control-sm" name="end_date"
                                               value="{{ end_date if end_date else '' }}"
                                               min="{{ min_date }}" max="{{ max_date }}" placeholder="Конечная дата">
                                    </div>
                                    <div class="col-12">
                                        <div class="d-flex gap-2 mt-2">
                                            <button type="submit" class="btn btn-primary btn-sm flex-grow-1">
                                                <i class="bi bi-funnel me-1"></i> Применить
                                            </button>
                                            {% if start_date or end_date %}
                                                <a href="{{ url_for('dashboard') }}" class="btn btn-danger btn-sm">
                                                    <i class="bi bi-x"></i>
                                                </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </form>

                            {% if start_date or end_date %}
                            <div class="mt-2">
                                <form method="POST" action="{{ url_for('cancel_bookings_in_range') }}" id="delete-range-form">
                                    <input type="hidden" name="start_date" value="{{ start_date }}">
                                    <input type="hidden" name="end_date" value="{{ end_date }}">
                                    <button type="submit" class="btn btn-outline-danger btn-sm w-100" onclick="return confirm('Вы уверены, что хотите удалить все бронирования в выбранном диапазоне?')">
                                        <i class="bi bi-trash me-1"></i> Удалить все в диапазоне
                                    </button>
                                </form>
                            </div>
                            {% endif %}
                        </div>

                        {% if bookings %}
                            <div class="list-group">
                                {% for booking in bookings %}
                                <div class="booking-card">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="flex-grow-1">
                                            <h5 class="mb-1"><i class="bi bi-geo-alt me-2"></i>Место {{ booking.place }}</h5>
                                            <span class="text-muted small">
                                                <i class="bi bi-building me-1"></i>{{ booking.location }}
                                            </span>
                                            <div class="mt-2">
                                                <span class="fw-bold text-primary fs-6">{{ booking.start_dt.strftime('%d.%m.%Y') }}</span>
                                                <div class="booking-time">
                                                    <i class="bi bi-clock"></i>
                                                    <span>{{ booking.start_dt.strftime('%H:%M') }} - {{ booking.end_dt.strftime('%H:%M') }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <a href="{{ url_for('cancel', booking_id=booking.id) }}" class="btn btn-sm btn-outline-danger ms-2" style="white-space: nowrap;">
                                            <i class="bi bi-x-circle"></i> Отменить
                                        </a>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-4">
                                <i class="bi bi-calendar-x" style="font-size: 3rem; color: #adb5bd;"></i>
                                <h5 class="mt-3">Нет активных бронирований</h5>
                                <p class="text-muted">У вас пока нет забронированных рабочих мест</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="card" data-aos="fade-up" data-aos-delay="200">
                    <div class="card-header">
                        <i class="bi bi-info-circle me-2"></i>Информация о системе
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex align-items-center">
                                <div class="bg-primary rounded p-2 me-3">
                                    <i class="bi bi-calendar-check text-white"></i>
                                </div>
                                <div>
                                    <strong>Правила бронирования</strong>
                                    <div class="text-muted">Макс. до 30 дней вперед</div>
                                </div>
                            </li>
                            <li class="list-group-item d-flex align-items-center">
                                <div class="bg-primary rounded p-2 me-3">
                                    <i class="bi bi-clock text-white"></i>
                                </div>
                                <div>
                                    <strong>Время бронирования</strong>
                                    <div class="text-muted">Круглосуточно</div>
                                </div>
                            </li>
                            <li class="list-group-item d-flex align-items-center">
                                <div class="bg-primary rounded p-2 me-3">
                                    <i class="bi bi-building text-white"></i>
                                </div>
                                <div>
                                    <strong>Доступные локации</strong>
                                    <div class="text-muted">
                                        {% for location in locations %}
                                            <span class="badge bg-light text-dark me-1 mb-1">{{ location }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </li>
                            <li class="list-group-item d-flex align-items-center">
                                <div class="bg-primary rounded p-2 me-3">
                                    <i class="bi bi-eye text-white"></i>
                                </div>
                                <div>
                                    <strong>Отображение бронирований</strong>
                                    <div class="text-muted">Только будущие брони</div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения удаления всех бронирований -->
<div class="modal fade" id="deleteAllModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Подтверждение удаления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Вы уверены, что хотите удалить <strong>все ваши бронирования</strong>?</p>
                <p class="text-danger small">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    Это действие нельзя отменить. Все ваши будущие бронирования будут удалены.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <form method="POST" action="{{ url_for('cancel_all_bookings') }}" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Удалить все бронирования</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Функция для преобразования строки в число для сортировки
        function parsePlaceNumber(number) {
            return parseFloat(number);
        }

        // Флаг для отслеживания инициализации
        let isInitialized = false;

        // Функция для нормализации даты (установка времени в 00:00:00)
        function normalizeDate(date) {
            const normalized = new Date(date);
            normalized.setHours(0, 0, 0, 0);
            return normalized;
        }

        // Функция для получения timestamp даты
        function getDateTimestamp(date) {
            return normalizeDate(date).getTime();
        }

        // Функция для проверки валидности времени
        function validateTime() {
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;
            const validationError = document.getElementById('time-validation-error');

            if (startTime && endTime && startTime >= endTime) {
                validationError.style.display = 'block';
                return false;
            } else {
                validationError.style.display = 'none';
                return true;
            }
        }

        // Функция для показа ошибки времени с фокусировкой
        function showTimeError() {
            const startTimeInput = document.getElementById('start-time');
            const validationError = document.getElementById('time-validation-error');

            validationError.style.display = 'block';
            startTimeInput.focus();
            startTimeInput.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Показываем всплывающее сообщение
            showFlashMessage('Время начала не может быть больше времени окончания', 'error');
        }

        // Функция для сброса выбранного места
        function resetSelectedPlace() {
            // Сбрасываем выделение
            document.querySelectorAll('.place-available').forEach(el => {
                el.classList.remove('selected');
            });

            // Очищаем hidden input
            document.getElementById('selected-place-id').value = '';

            // Деактивируем кнопку бронирования
            document.getElementById('book-button').disabled = true;
        }

        // Инициализация валидации времени
        document.getElementById('start-time').addEventListener('change', function() {
            validateTime();
        });
        document.getElementById('end-time').addEventListener('change', function() {
            validateTime();
        });

        // Функция для добавления дней недели
        function addWeekdays(dayOfWeek) {
            if (!window.fp) {
                console.error('Flatpickr not initialized');
                return;
            }

            // Получаем текущие выбранные даты
            const currentDates = window.fp.selectedDates.map(d => new Date(d));
            const currentTimestamps = new Set(currentDates.map(getDateTimestamp));

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const maxDate = new Date();
            maxDate.setDate(today.getDate() + 30);
            maxDate.setHours(0, 0, 0, 0);

            const datesToAdd = [];
            const currentDate = new Date(today);

            // Добавляем только уникальные даты
            while (currentDate <= maxDate) {
                currentDate.setHours(0, 0, 0, 0);

                if (currentDate.getDay() === dayOfWeek) {
                    const timestamp = getDateTimestamp(currentDate);
                    if (!currentTimestamps.has(timestamp)) {
                        datesToAdd.push(new Date(currentDate));
                        currentTimestamps.add(timestamp);
                    }
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Создаем новый массив дат
            const newSelectedDates = [...currentDates, ...datesToAdd];

            // Убираем возможные дубликаты
            const uniqueDates = [];
            const seenTimestamps = new Set();

            newSelectedDates.forEach(date => {
                const timestamp = getDateTimestamp(date);
                if (!seenTimestamps.has(timestamp)) {
                    seenTimestamps.add(timestamp);
                    uniqueDates.push(date);
                }
            });

            // Сортируем даты
            uniqueDates.sort((a, b) => a - b);

            // Обновляем календарь
            window.fp.setDate(uniqueDates);

            // Обновляем отображение выбранных дат
            if (window.updateSelectedDates) {
                window.updateSelectedDates(uniqueDates);
            }

            // Сбрасываем выбранное место при изменении дат
            resetSelectedPlace();

            // Автоматически обновляем доступные места, если они уже отображаются
            autoUpdateAvailablePlaces();
        }

        // Функция для автоматического обновления доступных мест
        function autoUpdateAvailablePlaces() {
            const availablePlacesContainer = document.getElementById('available-places-container');
            if (availablePlacesContainer.style.display !== 'none') {
                checkAvailability();
            }
        }

        // Инициализация обработчиков
        function initializeEventHandlers() {
            if (isInitialized) return;

            // Удаляем старые обработчики
            const newSelectWorkdays = document.getElementById('select-workdays').cloneNode(true);
            document.getElementById('select-workdays').parentNode.replaceChild(newSelectWorkdays, document.getElementById('select-workdays'));

            const newClearDates = document.getElementById('clear-dates').cloneNode(true);
            document.getElementById('clear-dates').parentNode.replaceChild(newClearDates, document.getElementById('clear-dates'));

            // Добавляем обработчики для кнопок дней недели
            document.querySelectorAll('.day-selector').forEach(btn => {
                btn.addEventListener('click', function() {
                    const dayOfWeek = parseInt(this.dataset.day);
                    addWeekdays(dayOfWeek);
                });
            });

            // Кнопка выбора всех рабочих дней
            document.getElementById('select-workdays').addEventListener('click', function() {
                if (!window.fp) return;

                const currentDates = window.fp.selectedDates.map(d => new Date(d));
                const currentTimestamps = new Set(currentDates.map(getDateTimestamp));

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const maxDate = new Date();
                maxDate.setDate(today.getDate() + 30);
                maxDate.setHours(0, 0, 0, 0);

                const datesToAdd = [];
                const currentDate = new Date(today);

                while (currentDate <= maxDate) {
                    currentDate.setHours(0, 0, 0, 0);

                    // 1-5: понедельник-пятница
                    if (currentDate.getDay() >= 1 && currentDate.getDay() <= 5) {
                        const timestamp = getDateTimestamp(currentDate);
                        if (!currentTimestamps.has(timestamp)) {
                            datesToAdd.push(new Date(currentDate));
                            currentTimestamps.add(timestamp);
                        }
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                // Создаем новый массив дат
                const newSelectedDates = [...currentDates, ...datesToAdd];

                // Убираем возможные дубликаты
                const uniqueDates = [];
                const seenTimestamps = new Set();

                newSelectedDates.forEach(date => {
                    const timestamp = getDateTimestamp(date);
                    if (!seenTimestamps.has(timestamp)) {
                        seenTimestamps.add(timestamp);
                        uniqueDates.push(date);
                    }
                });

                // Сортируем даты
                uniqueDates.sort((a, b) => a - b);

                // Обновляем календарь
                window.fp.setDate(uniqueDates);

                // Обновляем отображение выбранных дат
                if (window.updateSelectedDates) {
                    window.updateSelectedDates(uniqueDates);
                }

                // Сбрасываем выбранное место
                resetSelectedPlace();

                // Автоматически обновляем доступные места
                autoUpdateAvailablePlaces();
            });

            // Кнопка очистки
            document.getElementById('clear-dates').addEventListener('click', function() {
                if (window.fp) {
                    window.fp.clear();
                    if (window.updateSelectedDates) {
                        window.updateSelectedDates([]);
                    }
                    // Сбрасываем выбранное место
                    resetSelectedPlace();
                    // Автоматически обновляем доступные места
                    autoUpdateAvailablePlaces();
                }
            });

            // Сбрасываем чекбокс при изменении локации
            document.getElementById('location-select').addEventListener('change', function() {
                document.getElementById('save-as-default').checked = false;
                // Сбрасываем выбранное место
                resetSelectedPlace();
                // Автоматически обновляем доступные места, если они уже отображаются
                autoUpdateAvailablePlaces();
            });

            isInitialized = true;
        }

        // Функция для проверки доступности мест
        function checkAvailability() {
            // Проверяем валидность времени перед проверкой доступности
            if (!validateTime()) {
                showTimeError();
                return;
            }

            const location = document.getElementById('location-select').value;
            const selectedDates = window.fp ? window.fp.selectedDates : [];
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;

            if (!location) {
                showFlashMessage('Пожалуйста, выберите локацию', 'error');
                return;
            }

            if (selectedDates.length === 0) {
                showFlashMessage('Пожалуйста, выберите хотя бы одну дату', 'error');
                return;
            }

            if (!startTime || !endTime) {
                showFlashMessage('Пожалуйста, укажите время бронирования', 'error');
                return;
            }

            // Получаем название выбранной локации
            const locationSelect = document.getElementById('location-select');
            const selectedLocationName = locationSelect.options[locationSelect.selectedIndex].text;
            document.getElementById('selected-location-name').textContent = selectedLocationName;

            // Форматируем даты для отправки
            const dates = selectedDates.map(date => window.formatDate(date));

            // Показываем загрузку
            document.getElementById('available-places').innerHTML =
                '<div class="text-center w-100 py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Проверяем доступность...</p></div>';
            document.getElementById('available-places-container').style.display = 'block';

            // Обновляем информацию о выбранном времени
            const startTimeFormatted = new Date(`2000-01-01T${startTime}`).toLocaleTimeString('ru-RU', {
                hour: '2-digit', minute: '2-digit'
            });
            const endTimeFormatted = new Date(`2000-01-01T${endTime}`).toLocaleTimeString('ru-RU', {
                hour: '2-digit', minute: '2-digit'
            });
            document.getElementById('selected-time-range').textContent =
                `${startTimeFormatted} - ${endTimeFormatted}`;

            // Отправляем запрос на сервер
            fetch('/get_available_places', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    location: location,
                    dates: dates,
                    start_time: startTime,
                    end_time: endTime
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showFlashMessage('Ошибка: ' + data.error, 'error');
                    return;
                }

                displayAvailablePlaces(data.available_places || []);
            })
            .catch(error => {
                console.error('Error:', error);
                showFlashMessage('Произошла ошибка при проверке доступности мест', 'error');
            });
        }

        // Функция для отображения доступных мест
        function displayAvailablePlaces(places) {
            const container = document.getElementById('available-places');
            container.innerHTML = '';

            if (places.length === 0) {
                container.innerHTML = '<div class="alert alert-warning w-100">Нет доступных мест на выбранные даты</div>';
                return;
            }

            // Сортируем места по номеру (преобразуя строки в числа для правильной сортировки)
            places.sort((a, b) => parsePlaceNumber(a.number) - parsePlaceNumber(b.number));

            // Создаем элементы для каждого места из ответа сервера
            places.forEach(placeInfo => {
                const placeElement = document.createElement('div');
                placeElement.className = `place ${placeInfo.available ? 'place-available' : 'place-unavailable'}`;
                placeElement.textContent = placeInfo.number;

                if (placeInfo.available) {
                    placeElement.dataset.placeId = placeInfo.id;
                    placeElement.addEventListener('click', function() {
                        selectPlace(placeInfo.id, placeInfo.number);
                    });
                    placeElement.title = 'Нажмите, чтобы выбрать это место';
                } else {
                    placeElement.title = 'Место занято на выбранные даты';
                }

                container.appendChild(placeElement);
            });
        }

        // Функция выбора места
        function selectPlace(placeId, placeNumber) {
            // Сбрасываем предыдущее выделение
            document.querySelectorAll('.place-available').forEach(el => {
                el.classList.remove('selected');
            });

            // Выделяем выбранное место
            const selectedElement = document.querySelector(`.place[data-place-id="${placeId}"]`);
            if (selectedElement) {
                selectedElement.classList.add('selected');
            }

            // Устанавливаем значение в hidden input
            document.getElementById('selected-place-id').value = placeId;

            // Активируем кнопку бронирования
            document.getElementById('book-button').disabled = false;

            // Плавно прокручиваем к кнопке бронирования
            document.getElementById('book-button').scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }

        // Функция для показа всплывающих сообщений
        function showFlashMessage(message, type) {
            // Создаем элемент уведомления
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1060; min-width: 300px;';
            alertDiv.innerHTML = `
                <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            // Добавляем в body
            document.body.appendChild(alertDiv);

            // Автоматически закрываем через 5 секунд
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Обработчик для чекбокса "Использовать как локацию по умолчанию"
        document.getElementById('save-as-default').addEventListener('change', function() {
            const location = document.getElementById('location-select').value;
            const saveAsDefault = this.checked;

            if (saveAsDefault && !location) {
                showFlashMessage('Пожалуйста, выберите локацию для сохранения', 'warning');
                this.checked = false;
                return;
            }

            // Отправляем запрос на сервер
            fetch('/save_default_location', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    location: location,
                    save_as_default: saveAsDefault
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showFlashMessage(data.message, 'success');
                } else {
                    showFlashMessage(data.error, 'error');
                    this.checked = !saveAsDefault; // Возвращаем предыдущее состояние
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showFlashMessage('Произошла ошибка при сохранении локации', 'error');
                this.checked = !saveAsDefault; // Возвращаем предыдущее состояние
            });
        });

        // Обработчик отправки формы бронирования
        document.getElementById('booking-form').addEventListener('submit', function(e) {
            // Проверяем валидность времени перед отправкой
            if (!validateTime()) {
                e.preventDefault();
                showTimeError();
                return;
            }

            // Проверяем, что место выбрано
            const selectedPlaceId = document.getElementById('selected-place-id').value;
            if (!selectedPlaceId) {
                e.preventDefault();
                showFlashMessage('Пожалуйста, выберите место для бронирования', 'error');
                return;
            }

            // Проверяем, что есть выбранные даты
            const selectedDates = window.fp ? window.fp.selectedDates : [];
            if (selectedDates.length === 0) {
                e.preventDefault();
                showFlashMessage('Пожалуйста, выберите хотя бы одну дату', 'error');
                return;
            }
        });

        // Инициализация после загрузки flatpickr
        function initAfterFlatpickr() {
            if (window.fp && typeof window.updateSelectedDates === 'function') {
                // Переопределяем функцию updateSelectedDates для автоматического обновления и сброса выбранного места
                const originalUpdateSelectedDates = window.updateSelectedDates;
                window.updateSelectedDates = function(selectedDates) {
                    originalUpdateSelectedDates(selectedDates);
                    // Сбрасываем выбранное место при изменении дат
                    resetSelectedPlace();
                    autoUpdateAvailablePlaces();
                };

                initializeEventHandlers();
            } else {
                // Если flatpickr еще не загрузился, ждем
                setTimeout(initAfterFlatpickr, 100);
            }
        }

        // Запускаем инициализацию
        initAfterFlatpickr();

        // Назначаем обработчик на кнопку проверки доступности
        document.getElementById('check-availability-btn').addEventListener('click', checkAvailability);

        // Инициализируем валидацию времени при загрузке
        validateTime();
    });
</script>
{% endblock %}